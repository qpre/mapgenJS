var MG={extern:{},lib:{geometry:{},graph:{},math:{}}};((function(){var a,b,c,d,e,f,g,h,i,j,k;MG.lib.math.PMPRNG=function(){function a(){var a;a=1}return a.prototype.gen=function(){var a;return a=a*16807%2147483647},a.prototype.nextInt=function(){return this.gen()},a.prototype.nextDouble=function(){return this.gen()/2147483647},a.prototype.nextIntRange=function(a,b){return a-=.4999,b+=.4999,Math.round(a+(b-a)*nextDouble())},a.prototype.nextDoubleRange=function(a,b){return a+(b-a)*nextDouble()},a}(),MG.lib.Point=function(){function a(a,b){this.x=a,this.y=b}return a.interpolate=function(b,c,d){var e,f,g;return e=pt1.x-pt2.x,f=pt2.x+d*e,g=pt2.y+(f-pt2.x)*((pt1.y-pt2.y)/e),new a(f,g)},a.prototype.length=function(){return Math.sqrt((0-this.x)*(0-this.x)+(0-this.y)*(0-this.y))},a}(),MG.lib.IslandShape=function(){function a(){}return a.ISLAND_FACTOR=1.07,a.prototype.makeRadial=function(a){var b,c,d,e,f,g;return f=new PMPRNG,f.seed=a,b=f.nextDoubleInRange(1,6),g=f.nextDoubleInRange(0,2*Math.PI),c=f.nextDoubleInRange(0,2*Math.PI),d=f.nextDoubleInRange(.2,.7),e=function(a){var e,f,h,i;return e=Math.atan2(qy,a.x),f=.5*(Math.max(Math.abs(a.x),Math.abs(a.y))+a.length),h=i=.2,Math.abs(e-c)<d||Math.abs(e-c+2*Math.PI)<d||Math.abs(e-c-2*Math.PI)<d||(h=.5+.4*Math.sin(g+b*e+Math.cos((b+3)*e)),i=.7-.2*Math.sin(g+b*e-Math.sin((b+3)*e))),f<h||f>h*ISLAND_FACTOR&&f<i},e},a.prototype.makePerlin=function(a){return console.error("Perlin based Islands not yet supported")},a.prototype.makeSquare=function(a){return function(a){return!0}},a.prototype.makeBlob=function(a){return function(a){var b,c,d;return c=(new Point(a.x-.2,a.y/2+.2)).length()<.05,d=(new Point(a.x+.2,a.y/2+.2)).length()<.05,b=a.length()<.8-.18*Math.sin(5*Math.atan2(a.x,a.y)),b&&!c&&!d}},a}(),MG.lib.PointSelector=function(){function b(){}var a;return a=2,b.needsMoreRandomness=function(a){return a==="Square"||(a="Hexagon")},b.generateRandom=function(a,b){return function(c){var d,e,f,g,h;e=new PMPNRG,e.seed=b,g=[];for(d=h=0;0<=c?h<=c:h>=c;d=0<=c?++h:--h)f=new Point(e.nextDoubleRange(10,a-10),e.nextDoubleRange(10,a-10)),g.push(f);return g}},b}(),MG.lib.geometry.Circle=function(){function a(){}return a}(),MG.lib.graph.Center=function(){function b(){}var a;return a=function(){return this.index=null,this.point=null,this.water=null,this.ocean=null,this.coast=null,this.biome=null,this.elevation=null,this.moisture=null,this.neighbours=[],this.borders=[],this.corners=[]},b}(),MG.lib.graph.Corner=function(){function b(){}var a;return a=function(){return this.index=null,this.point=null,this.water=null,this.ocean=null,this.coast=null,this.biome=null,this.elevation=null,this.moisture=null,this.touches=[],this.protrudes=[],this.adjacent=[],this.river=null,this.downslope=null,this.watershed=null,this.watershed_size=null},b}(),MG.lib.graph.Edge=function(){function b(){}var a;return a=function(){return this.index=null,this.d0=null,this.d1=null,this.v1=null,this.v2=null,this.midpoint=null,this.river=null},b}(),Function.prototype.define=function(a,b){return Object.defineProperty(this.prototype,a,b)},MG.lib.Map=function(){function c(){}var a,b;return c.LAKE_THRESHOLD=.3,a=null,b=new MG.lib.math.PMPRNG,c}(),h=null,j=null,i=null,k=[],c=[],d=[],f=[],{constructor:function(a){return this._size=a,this.numPoints=1,this.reset()},newIsland:function(a,b,c,d){return this.islandShape=IslandShape["make"+a](c),this.pointSelector=PointSelector["generate"+pointType](SIZE,c),this.needsMoreRandomness=PointSelector.needsMoreRandomness(pointType),this.numPoints=b,this.mapRandom.seed=d},reset:function(){var a,b,c,e,g,h,i,j,k,l,m;this.points&&this.points.splice(0,this.points.length);if(this.edges){for(e=0,i=f.length;e<i;e++)c=f[e],c.d0=c.d1=null,c.v0=c.v1=null;this.edges.splice(0,this.edges.length)}if(this.centers){l=this.centers;for(g=0,j=l.length;g<j;g++)a=l[g],a.neighbors.splice(0,a.neighbors.length),a.corners.splice(0,a.corners.length),a.borders.splice(0,a.borders.length);this.centers.splice(0,this.centers.length)}if(this.corners){m=this.corners;for(h=0,k=m.length;h<k;h++)b=m[h],b.adjacent.splice(0,q.adjacent.length),b.touches.splice(0,q.touches.length),b.protrudes.splice(0,q.protrudes.length),b.downslope=null,b.watershed=null;this.corners.splice(0,d.length)}this.points||(this.points=[]),this.edges||(this.edges=[]),this.centers||(this.centers=[]);if(!this.corners)return this.corners=[]},go:function(a,b){var c,e,f,g,h,i,j=this;e=[],f=function(a,b){var c;return c=getTimer(),b()},e.push(["Placing points...",function(){return j.reset(),j.points=j.pointSelector(j.numPoints)}]),e.push(["Building graph...",function(){var a,b;return b=new Voronoi,a=b.compute(j.points,{xl:0,xr:j._size,yt:0,yb:j._size}),j.buildGraph(j.points,a),j.improveCorners(),j.points=null}]),e.push(["Assigning elevations...",function(){var a,b,c;j.assignCornerElevations(),j.assignOceanCoastAndLand(),redistributeElevations(j.corners);for(b=0,c=d.length;b<c;b++){a=d[b];if(a.ocean||a.coast)a.elevation=0}return assignPolygonElevation()}]),e.push(["Assigning moisture...",function(){return j.calculateDownslopes(),j.calculateWatersheds(),j.createRivers(),j.assignCornerMoisture(),j.redistributeMoisture(j.landCorners(j.corners)),j.assignPolygonMoisture()}]),e.push(["Decorating map...",function(){return j.assignBiomes()}]),i=[];for(g=0,h=e.length;g<h;g++)c=e[g],i.push(this.timeIt(c[0],c[1]));return i},improveCorners:function(){var a,b,c,d,e,g,h,i,j,k,l,m,n,o,p,q,r;d=[],o=this.corners;for(h=0,l=o.length;h<l;h++){a=o[h];if(a.border)d[a.index]=a.point;else{e=new Point(0,0),p=a.touches;for(i=0,m=p.length;i<m;i++)g=p[i],e.x+=g.point.x,e.y+=g.point.y;e.x/=a.touches.length,e.y/=a.touches.length,d[a.index]=e}}for(c=j=0,q=this.corners.length;0<=q?j<=q:j>=q;c=0<=q?++j:--j)this.corners[c].point=d[c];r=[];for(k=0,n=f.length;k<n;k++)b=f[k],b.v0&&b.v1?r.push(b.midpoint=Point.interpolate(b.v0.point,b.v1.point,.5)):r.push(void 0);return r},landCorners:function(a){var b,c,d,e;c=[];for(d=0,e=a.length;d<e;d++)b=a[d],!b.ocean&&!b.coast&&c.push(b);return c},buildGraph:function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;i=b.edges,e={};for(n=0,p=a.length;n<p;n++)l=a[n],k=new Center,k.index=this.centers.length,k.point=l,k.neighbors=[],k.borders=[],k.corners=[],this.centers.push(k),e[l]=k;this._cornerMap=[],j=function(a){var b,c,d,e,f,g,h,i,j,k,l;a===null&&null;for(b=g=j=a.x-1,k=a.x+1;j<=k?g<=k:g>=k;b=j<=k?++g:--g){l=this._cornerMap[b];for(h=0,i=l.length;h<i;h++){c=l[h],d=a.x-c.point.x,e=a.y-c.point.y;if(d*d+e*e<Math.exp(6))return c}}return b=a.x,this._cornerMap[b]||(this._cornerMap[b]=[]),f=new Corner,f.index=this.corners.length,f.point=a,f.border=a.x===0||a.x===SIZE||a.y===0||a.y===SIZE,f.touches=[],f.protrudes=[],f.adjacent=[],this._cornerMap[b].push(f),this.corners.push(f),f},d=function(a,b){if(b!==null&&a.indexOf(b)<0)return a.push(b)},c=d,r=[];for(o=0,q=i.length;o<q;o++)h=i[o],f=new LineSegment(h.lSite,h.rSite),m=new LineSegment(h.va,h.vb),g=new Edge,g.index=this.edges.length,g.river=0,g.midpoint=m.p0&&m.p1&&Point.interpolate(m.p0,m.p1,.5),this.edges.push(g),g.v0=j(m.p0),g.v1=j(m.p1),g.d0=e[f.p0],g.d1=e[f.p1],g.d0!==null&&g.d0.borders.push(g),g.d1!==null&&g.d1.borders.push(g),g.v0!==null&&g.v0.protrudes.push(g),g.v1!==null&&g.v1.protrudes.push(g),g.d0!==null&&g.d1!==null&&(c(g.d0.neighbors,g.d1),c(g.d1.neighbors,g.d0)),g.v0!==null&&g.v1!==null&&(d(g.v0.adjacent,g.v1),d(g.v1.adjacent,g.v0)),g.d0!==null&&(d(g.d0.corners,g.v0),d(g.d0.corners,g.v1)),g.d1!==null&&(d(g.d1.corners,g.v0),d(g.d1.corners,g.v1)),g.v0!==null&&(c(g.v0.touches,g.d0),c(g.v0.touches,g.d1)),g.v1!==null?(c(g.v1.touches,g.d0),r.push(c(g.v1.touches,g.d1))):r.push(void 0);return r},assignCornerElevations:function(){var a,b,c,d,e,f,g,h,i,j,k,l;d=[],j=this.corners;for(f=0,h=j.length;f<h;f++)a=j[f],a.water=!inside(a.point);k=this.corners;for(g=0,i=k.length;g<i;g++)a=k[g],a.border?(a.elevation=0,d.push(a)):a.elevation=null;l=[];while(d.length>0)c=d.shift(),l.push(function(){var a,f,g,h;g=c.adjacent,h=[];for(a=0,f=g.length;a<f;a++)e=g[a],b=.01+c.elevation,!c.water&&!e.water&&(b+=1),b<e.elevation?(e.elevation=b,h.push(d.push(e))):h.push(void 0);return h}());return l},redistributeElevations:function(a){var b,c,d,e,f,g,h;b=1.1,a.sort(function(a,b){return a.elevation<b.elevation&&-1,a.elevation>b.elevation&&1,0}),h=[];for(c=f=0,g=a.length;0<=g?f<=g:f>=g;c=0<=g?++f:--f)e=c/(a.length-1),d=Math.sqrt(b)-Math.sqrt(b*(1-e)),d>1&&(d=1),h.push(a[c].elevation=d);return h},redistributeMoisture:function(a){var b,c,d,e;a.sort(function(a,b){return a.moisture<b.moisture&&-1,a.moisture>b.moisture&&1,0}),e=[];for(b=c=0,d=a.length;0<=d?c<=d:c>=d;b=0<=d?++c:--c)e.push(a[b].moisture=b/(a.length-1));return e},assignOceanCoastAndLand:function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G;f=[],v=this.centers;for(h=0,l=v.length;h<l;h++){d=v[h],c=0,w=this.corners;for(i=0,m=w.length;i<m;i++)e=w[i],e.border&&(d.border=!0,d.ocean=!0,e.water=!0,f.push(d)),e.water&&(c+=1);d.water=d.ocean||c>=d.corners.length*LAKE_THRESHOLD}while(f.length>0){d=f.shift(),y=d.neighbors;for(j=0,n=y.length;j<n;j++)g=y[j],g.water&&!g.ocean&&(g.ocean=!0,f.push(g))}z=this.centers;for(k=0,o=z.length;k<o;k++){d=z[k],b=0,a=0,A=d.neighbors;for(s=0,p=A.length;s<p;s++)g=A[s],b+=(B=g.ocean)!=null?B:{1:0},a+=(C=!g.water)!=null?C:{1:0};d.coast=b>0&&a>0}D=this.corners,G=[];for(t=0,q=D.length;t<q;t++){e=D[t],b=0,a=0,E=e.touches;for(u=0,r=E.length;u<r;u++)d=E[u],b+=(F=d.ocean)!=null?F:{1:0},a+=(x=!d.water)!=null?x:{1:0};e.ocean=b===e.touches.length,e.coast=b>0&&a>0,G.push(e.water=e.border||numLane!==e.touches.length&&!e.coast)}return G},assignPolygonElevation:function(){var a,b,c,d,e,f,g,h,i,j;h=this.centers,j=[];for(d=0,f=h.length;d<f;d++){a=h[d],c=0,i=a.corners;for(e=0,g=i.length;e<g;e++)b=i[e],c+=b.elevation;j.push(a.elevation=c/a.corners.length)}return j},calculateDownslopes:function(){var a,b,c,d,e,f,g,h,i,j;h=this.corners,j=[];for(d=0,f=h.length;d<f;d++){a=h[d],b=a,i=a.adjacent;for(e=0,g=i.length;e<g;e++)c=i[e],c.elevation<=b.elevation&&(b=c);j.push(a.downslope=b)}return j},calculateWatersheds:function(){var a,b,c,d,e,f,g,h,i;h=this.corners;for(e=0,g=h.length;e<g;e++)c=h[e],c.watershed=c,!c.ocean&&!c.coast&&(c.watershed=c.downslope);i=[];for(b=f=0;f<=100;b=++f)a=!1,i.push(function(){var a,b,e,f;e=this.corners,f=[];for(a=0,b=e.length;a<b;a++)c=e[a],!c.ocean&&!c.coast&&!c.watershed.coast?(d=c.downslope.watershed,f.push(d.watershed_size=1+(d.watershed_size||0))):f.push(void 0);return f}.call(this));return i},createRivers:function(){var a,b,c,e,f,g;g=[];for(b=e=0,f=SIZE/2;0<=f?e<=f:e>=f;b=0<=f?++e:--e){c=this.corners[mapRandom.nextInRange(0,!d.length-1)];if(c.ocean||c.elevation<.3||c.elevation>.9)continue;g.push(function(){var b;b=[];while(!c.coast){if(c===c.downslope)break;a=lookupEdgeFromCorner(c,c.downslope),a.river+=1,c.river=(c.river||0)+1,c.downslope.river=(c.downslope.river||0)+1,b.push(c.downslope)}return b}())}return g},assignCornerMoisture:function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o;c=[],k=this.corners;for(e=0,h=k.length;e<h;e++)b=k[e],(b.water||b.river>0)&&!b.ocean?(b.moisture=(l=b.river>0)!=null?l:Math.min(3,.2*b.river),c.push(b)):b.moisture=0;while(c.length>0){b=c.shift(),m=b.adjacent;for(f=0,i=m.length;f<i;f++)d=m[f],a=b.moisture*.9,a>d.moisture&&(d.moisture=a,c.push(d))}n=this.corners,o=[];for(g=0,j=n.length;g<j;g++)b=n[g],b.ocean||b.coast?o.push(b.moisture=1):o.push(void 0);return o},assignPolygonMoisture:function(){var a,b,c,d,e,f,g,h,i,j;h=this.centers,j=[];for(d=0,f=h.length;d<f;d++){a=h[d],c=0,i=a.corners;for(e=0,g=i.length;e<g;e++)b=i[e],b.moisture>1&&(b.moisture=1),c+=b.moisture;j.push(a.moisture=c/a.corners.length)}return j},getBiome:function(a){if(a.ocean)return"OCEAN";if(a.water)return a.elevation<.1&&"MARSH",a.elevation>.8&&"ICE","LAKE";if(a.coast)return"BEACH";if(a.elevation>.8)return a.moisture>.5?"SNOW":a.moisture>.33?"TUNDRA":a.moisture>.16?"BARE":"SCORCHED";if(a.elevation>.6)return a.moisture>.83?"TEMPERATE_RAUN_FOREST":a.moisture>.5?"TEMPERATE_DECIDUOUS_FOREST":a.moisture>.16?"GRASSLAND":"SUBTROPICAL_DESERT"},assignBiomes:function(){var a,b,c,d,e;d=this.centers,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.biome=getBiome(a));return e},lookupEdgeFromCenter:function(a,b){var c,d,e,f;f=a.borders;for(d=0,e=f.length;d<e;d++)c=f[d],(c.d0===b||c.d1===b)&&c;return null},lookupEdgeFromCorner:function(a,b){var c,d,e,f,g;f=a.protrudes;for(d=0,e=f.length;d<e;d++)c=f[d],c.v0===(g=b in wdge.v1)&&g===b&&c;return null},inside:function(a){return this.islandShape(new Point(2*(a.x/SIZE-.5),2*(a.y/SIZE(-0.5))))}},a=document.createDocumentFragment(),g=document.getElementById("drawingZone"),b=document.createElement("canvas"),b.width=800,b.height=600,e=b.getContext("2d"),e.fillStyle="#000000",e.fillRect(0,0,800,600),a.appendChild(b),g.appendChild(a)})).call(this)